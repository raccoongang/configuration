---

# TODO: refactor to use roles/supervisor as meta role

- name: adding '{{ common_web_user }}' to adm group
  user:
    name: '{{ common_web_user }}'
    groups: adm
    append: yes
  notify: restart_supervisor

- name: write analytics_log_watcher supervisor configs
  template:
    src: "analytics_log_watcher.j2"
    dest: "{{ supervisor_available_dir }}/{{ analytics_log_watcher_service_name }}.conf"
    mode: 0650
    owner: "{{ supervisor_user }}"
    group: "{{ common_web_user }}"
  notify: update_supervisor

- name: enable analytics_log_watcher supervisor script
  file:
    src: "{{ supervisor_available_dir }}/{{ analytics_log_watcher_service_name }}.conf"
    dest: "{{ supervisor_cfg_dir }}/{{ analytics_log_watcher_service_name }}.conf"
    state: link
    force: yes
  notify: update_supervisor

- name: write analytics_processors supervisor configs
  template:
    src: "analytics_processors.j2"
    dest: "{{ supervisor_available_dir }}/{{ analytics_processors_service_name }}.conf"
    mode: 0650
    owner: "{{ supervisor_user }}"
    group: "{{ common_web_user }}"
  when: not RG_ANALYTICS_VERSION_2_3
  notify: update_supervisor

- name: enable analytics_processors supervisor script
  file:
    src: "{{ supervisor_available_dir }}/{{ analytics_processors_service_name }}.conf"
    dest: "{{ supervisor_cfg_dir }}/{{ analytics_processors_service_name }}.conf"
    state: link
    force: yes
  when: not RG_ANALYTICS_VERSION_2_3
  notify: update_supervisor

- name: remove analytics_processors on upgrade
  file:
    path: "{{ supervisor_available_dir }}/{{ analytics_processors_service_name }}.conf"
    state: absent
  when: RG_ANALYTICS_VERSION_2_3
  notify: update_supervisor
