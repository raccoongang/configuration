#!/bin/bash

# This file was generated by Ansible for {{ ansible_fqdn }}
# Do NOT modify this file by hand!

WORKDIR="{{ backup_work }}/{{ item[0]['name'] }}"

mkdir -p "${WORKDIR}"
chmod og-wrx "${WORKDIR}"

HOST="{{ item[0]['mongo_host'] | default('', true) }}"
USER="{{ item[0]['mongo_user'] | default('', true) }}"
PASS="{{ item[0]['mongo_password'] | default('', true) }}"
AUTHDB="{{ item[0]['mongo_authdb'] | default('', true) }}"
DATABASES="{{ item[0]['mongo_databases'] | default([], true) | join(' ') }}"

if [ ! -z ${HOST} ]; then HOST="--host ${HOST}" ; fi
if [ ! -z ${USER} ]; then USER="--username ${USER}" ; fi
if [ ! -z ${PASS} ]; then PASS="--password ${PASS}" ; fi
if [ ! -z ${AUTHDB} ]; then AUTHDB="--authenticationDatabase ${AUTHDB}" ; fi

if [ -z "${DATABASES}" ]; then
    mongodump ${HOST} ${AUTHDB} ${USER} ${PASS} --out $WORKDIR/dump
    DUMP_RETCODE=$?
else
    for db in ${DATABASES}; do
        mongodump ${HOST} ${AUTHDB} ${USER} ${PASS} --db ${db} --out $WORKDIR/dump
        RETCODE=$?
        DUMP_RETCODE=`expr 0${DUMP_RETCODE} + ${RETCODE}`
    done
fi

{% for action in item[0]['pre_actions']|default([]) %}
{{ action }}
{% endfor %}

if test ${DUMP_RETCODE} -ne 0 ; then
    echo "Errors: mongodump finished with errors. Please investigate"
    exit 1
fi
