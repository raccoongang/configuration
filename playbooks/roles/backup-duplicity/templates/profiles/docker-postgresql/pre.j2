#!/bin/bash

# This file was generated by Ansible for {{ ansible_fqdn }}
# Do NOT modify this file by hand!

WORKDIR="{{ backup_work }}/{{ item[0]['name'] }}"

mkdir -p "${WORKDIR}"
chmod og-wrx "${WORKDIR}"

{% if item[0]['docker-container'] is defined %}
DOCKER_CONTAINER="{{ item[0]['docker-container'] }}"
{% else %}
DOCKER_CONTAINER=`docker ps | grep postgres | awk '{ print $(NF); }'`
{% endif %}

docker exec -t "${DOCKER_CONTAINER}" pg_dumpall -c -U postgres > "${WORKDIR}"/dump
DUMP_RETCODE=$?

{% for action in item[0]['pre_actions']|default([]) %}
{{ action }}
{% endfor %}

if test ${DUMP_RETCODE} -ne 0 ; then
    echo "Errors: pg_dumpall finished with errors. Please investigate"
    exit 1
fi
