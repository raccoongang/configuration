#!/bin/bash

# This file was generated by Ansible for {{ ansible_fqdn }}
# Do NOT modify this file by hand!

WORKDIR="{{ backup_work }}/{{ item[0]['name'] }}"

mkdir -p "${WORKDIR}"
chmod og-wrx "${WORKDIR}"

echo "
[mysqldump]
host = {{ item[0]['mysql_host'] | default('localhost', true) }}
user = {{ item[0]['mysql_user'] | default('root', true) }}
password = {{ item[0]['mysql_password'] | default('', true) }}
" > "${WORKDIR}"/.my.cnf

chmod og-wrx "${WORKDIR}"/.my.cnf

DATABASES="{{ item[0]['mysql_databases'] | default([], true) | join(' ') }}"
if [ -z "${DATABASES}" ]; then
    DATABASES="--all-databases"
else
    DATABASES="--databases ${DATABASES}"
fi

mysqldump --defaults-extra-file="${WORKDIR}"/.my.cnf --opt --skip-lock-tables --skip-extended-insert --max_allowed_packet=4194304 -C ${DATABASES} > "${WORKDIR}"/dump
DUMP_RETCODE=$?

{% for action in item[0]['pre_actions']|default([]) %}
{{ action }}
{% endfor %}

rm -f "${WORKDIR}"/.my.cnf

if test ${DUMP_RETCODE} -ne 0 ; then
    echo "Errors: mysqldump finished with errors. Please investigate"
    exit 1
fi
