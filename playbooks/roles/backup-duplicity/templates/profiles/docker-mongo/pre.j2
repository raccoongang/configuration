#!/bin/bash

# This file was generated by Ansible for {{ ansible_fqdn }}
# Do NOT modify this file by hand!

WORKDIR="{{ backup_work }}/{{ item[0]['name'] }}"

mkdir -p "${WORKDIR}"
chmod og-wrx "${WORKDIR}"

{% if item[0]['docker-container'] is defined %}
DOCKER_CONTAINER="{{ item[0]['docker-container'] }}"
{% else %}
DOCKER_CONTAINER=`docker ps | grep mongo | awk '{ print $(NF); }'`
{% endif %}


if [ -z "${DATABASES}" ]; then
    docker run --rm --link ${DOCKER_CONTAINER}:mongo -v "${WORKDIR}":/backup mongo bash -c 'mongodump --out /backup/dump --host mongo:27017'
    DUMP_RETCODE=$?
else
    for db in ${DATABASES}; do
        docker run --rm --link ${DOCKER_CONTAINER}:mongo -v "${WORKDIR}":/backup mongo bash -c 'mongodump --db ${db} --out /backup/dump --host mongo:27017'
        RETCODE=$?
        DUMP_RETCODE=`expr 0${DUMP_RETCODE} + ${RETCODE}`
    done
fi

{% for action in item[0]['pre_actions']|default([]) %}
{{ action }}
{% endfor %}

if test ${DUMP_RETCODE} -ne 0 ; then
    echo "Errors: mongodump finished with errors. Please investigate"
    exit 1
fi
