#!/bin/bash

# This file was generated by Ansible for {{ ansible_fqdn }}
# Do NOT modify this file by hand!

WORKDIR="{{ backup_work }}/{{ item[0]['name'] }}"

if [ ! -d "${WORKDIR}"/dump ]; then
    echo "WARRNING: dump file not found ("${WORKDIR}"/dump). skipping mongo restore"
    exit
fi

{% if item[0]['docker-container'] is defined %}
DOCKER_CONTAINER="{{ item[0]['docker-container'] }}"
{% else %}
DOCKER_CONTAINER=`docker ps | grep postgres | awk '{ print $(NF); }'`
{% endif %}

{% for action in item[0]['pre_actions']|default([]) %}
{{ action }}
{% endfor %}

docker run --rm --link ${DOCKER_CONTAINER}:mongo -v ${WORKDIR}:/backup mongo bash -c 'mongorestore /backup/dump --host mongo:27017'
