---
- name: Ensure /var/log/zabbix directory exists
  file:
    path: "/var/log/zabbix"
    state: directory
    owner: zabbix
    group: zabbix

- name: Install logrotate configuration
  copy:
    src: "files/logrotate"
    dest: "/etc/logrotate.d/zabbix-agent"

- name: Update Zabbix agent configuration
  template:
    src: "zabbix_agentd.conf.j2"
    dest: "/etc/zabbix/zabbix_agentd.conf"
  notify: restart zabbix-agent
  tags:
    - zabbix-agent-config

- name: Installing python requirements into venv
  pip:
    name: "{{ item }}"
    virtualenv: "/etc/zabbix/.venv"
  with_items: "{{ zabbix_requirements_pip }}"

# deploying all scripts and userparams into separate
# directory to not raise false alerts due to script
# logic changes or new configuration settings
# after that fast swap directories and restart agent

- name: Preserve previous versions to notify restart handler on changes
  shell: "{{ item }}"
  args:
    warn: False
  with_items:
    - "rm -rf /etc/zabbix/scripts.new /etc/zabbix/zabbix_agentd.d.new"
    - "test -d /etc/zabbix/scripts && cp -Rap /etc/zabbix/scripts /etc/zabbix/scripts.new || true"
    - "test -d /etc/zabbix/zabbix_agentd.d && cp -Rap /etc/zabbix/zabbix_agentd.d /etc/zabbix/zabbix_agentd.d.new || true"
  tags:
    - skip_ansible_lint

- name: Deploying RG userparameters
  copy:
    src: "files/zabbix_agentd.d/"
    dest: "/etc/zabbix/zabbix_agentd.d.new/"
    mode: "0750"
    owner: zabbix
    group: zabbix
  notify: restart zabbix-agent

- name: Deploying RG scripts
  copy:
    src: "files/scripts/"
    dest: "/etc/zabbix/scripts.new/"
    mode: "0750"
    owner: zabbix
    group: zabbix

- name: Adding zabbix scripts configuration file
  template:
    src: "scripts/scripts.cfg.j2"
    dest: "/etc/zabbix/scripts.new/scripts.cfg"
    mode: "0600"
    owner: zabbix
    group: zabbix
  notify: restart zabbix-agent
  tags:
    - zabbix-agent-config

- name: Adding NOPASSWOD in sudoers for zabbix user
  lineinfile:
    dest: /etc/sudoers
    line: "zabbix ALL=(ALL) NOPASSWD: /etc/zabbix/scripts/"
    state: present
    insertafter: EOF

- name: Cleaning stale scripts
  file:
    path: "/etc/zabbix/scripts"
    state: "absent"

# copy module does not support recursive copy
# up to ansible 2.8
# TODO: upgrade ansible on AWX to 2.8 or greater

- name: Installing scripts
  command: "mv /etc/zabbix/scripts.new /etc/zabbix/scripts"
  tags:
    - skip_ansible_lint

- name: Cleaning stale userparameters
  file:
    path: "/etc/zabbix/zabbix_agentd.d"
    state: "absent"

- name: Installing userparameters
  command: "mv /etc/zabbix/zabbix_agentd.d.new /etc/zabbix/zabbix_agentd.d"
  tags:
    - skip_ansible_lint

- name: Removing deprecated .my.cnf
  file:
    path: "/var/lib/zabbix/.my.cnf"
    state: "absent"
  tags:
    - zabbix-agent-config

- name: Adding zabbix-agent service to startup
  service:
    name: zabbix-agent
    enabled: yes

- name: Running systemctl enable zabbix-agent as fix for issue https://github.com/ansible/ansible-modules-core/issues/3764
  shell: "systemctl enable zabbix-agent"
  ignore_errors: true

- name: Starting zabbix-agent
  service:
    name: zabbix-agent
    state: started
