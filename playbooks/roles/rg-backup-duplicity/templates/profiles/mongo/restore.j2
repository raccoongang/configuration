#!/bin/bash

# This file was generated by Ansible for {{ ansible_fqdn }}
# Do NOT modify this file by hand!

WORKDIR="{{ backup_work }}/{{ item[0]['name'] }}"

if [ ! -d "${WORKDIR}"/dump ]; then
    echo "WARRNING: dump file not found ("${WORKDIR}"/dump). skipping mongo restore"
    exit
fi

HOST = "{{ item[0]['mongo_host'] | default('', true) }}"
USER = "{{ item[0]['mongo_user'] | default('', true) }}"
PASS = "{{ item[0]['mongo_password'] | default('', true) }}"
AUTHDB = "{{ item[0]['mongo_authdb'] | default('', true) }}"
DATABASES="{{ item[0]['mongo_databases'] | default([], true) | join(' ') }}"

if [ ! -z ${HOST} ]; then HOST="--host ${HOST}" ; fi
if [ ! -z ${USER} ]; then USER="--username ${USER}" ; fi
if [ ! -z ${PASS} ]; then PASS="--password ${PASS}" ; fi
if [ ! -z ${AUTHDB} ]; then AUTHDB="--authenticationDatabase ${AUTHDB}" ; fi

{% for action in item[0]['pre_actions']|default([]) %}
{{ action }}
{% endfor %}

mongorestore ${HOST} ${AUTHDB} ${USER} ${PASS} --drop "${WORKDIR}"/dump
