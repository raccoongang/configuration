#!/bin/bash

# This file was generated by Ansible for {{ ansible_fqdn }}
# Do NOT modify this file by hand!

WORKDIR="{{ backup_work }}/{{ item[0]['name'] }}"

if [ ! -f "${WORKDIR}"/dump ]; then
    echo "WARRNING: dump file not found ("${WORKDIR}"/dump). skipping mysql restore"
    exit
fi

echo "
[mysql]
host = {{ item[0]['mysq_host'] | default('localhost', true) }}
user = {{ item[0]['mysq_user'] | default('root', true) }}
password = {{ item[0]['mysq_password'] | default('', true) }}
" > "${WORKDIR}"/.my.cnf

chmod og-wrx "${WORKDIR}"/.my.cnf

{% for action in item[0]['pre_actions']|default([]) %}
{{ action }}
{% endfor %}

cat <<EOF > "${WORKDIR}"/pre
SET @OLD_AUTOCOMMIT=@@AUTOCOMMIT, AUTOCOMMIT = 0;
SET @OLD_UNIQUE_CHECKS=@@UNIQUE_CHECKS, UNIQUE_CHECKS = 0;
SET @OLD_FOREIGN_KEY_CHECKS=@@FOREIGN_KEY_CHECKS, FOREIGN_KEY_CHECKS = 0;
EOF

cat <<EOF > "${WORKDIR}"/post
SET FOREIGN_KEY_CHECKS=@OLD_FOREIGN_KEY_CHECKS;
SET UNIQUE_CHECKS=@OLD_UNIQUE_CHECKS;
SET AUTOCOMMIT = @OLD_AUTOCOMMIT;
COMMIT;
EOF

cat "${WORKDIR}"/pre "${WORKDIR}"/dump "${WORKDIR}"/post | mysql --defaults-extra-file="${WORKDIR}"/.my.cnf

rm -f "${WORKDIR}"/.my.cnf
